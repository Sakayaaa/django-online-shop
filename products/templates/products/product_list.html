{% extends 'core/base.html' %}
{% block title %}
  Products - DigiStore
{% endblock %}
{% load tree_tags %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">Products</h3>
    <div class="small text-muted">
      {% if category %}
        Showing results for: <strong>{{ category.name }}</strong>
      {% else %}
        Showing all products
      {% endif %}
    </div>
  </div>

  <div class="row">
    <aside class="col-md-3">
      <div class="card p-3">
        <h6>Filters</h6>

        <!-- Category Filter -->
        <div class="mb-3">
          <label class="form-label" style="font-size: larger;">Categories</label>

          <div class="category-dropdown">
            <div class="dropdown-header">Select Category</div>
            <ul class="dropdown-list" style="display:none;">
              {% for c in all_categories %}
                {% if not c.parent %}
                  {% include 'products/category_recursive.html' with category=c %}
                {% endif %}
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Brand filter -->
        <div class="mb-3">
          <label class="form-label" style="font-size: larger;">Brand</label>
          <select name="brand" class="form-select">
            <option value="">All</option>
            {% for b in brands %}
              <option value="{{ b.slug }}" {% if brand and brand.slug == b.slug %}selected{% endif %}>
                {{ b.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <button id="apply-filter" class="btn btn-sm btn-primary mt-2 w-100">Apply</button>
      </div>
    </aside>

    <div class="col-md-9">
      <div class="row g-4">
        {% for p in products %}
          <div class="col-md-4">
            <div class="card product-card">
              {% if p.image %}
                <img src="{{ p.image.url }}" class="card-img-top" alt="{{ p.name }}" />
              {% endif %}
              <div class="card-body">
                <h6>{{ p.name }}</h6>
                <p class="text-danger fw-bold">${{ p.price }}</p>
                <a href="{% url 'products:product_detail' p.slug %}" class="btn btn-outline-danger btn-sm w-100">View</a>
              </div>
            </div>
          </div>
        {% empty %}
          <p class="text-muted">No products found.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const dropdownHeader = document.querySelector('.dropdown-header')
      const dropdownList = document.querySelector('.dropdown-list')
      const brandSelect = document.querySelector("select[name='brand']")
      const brandEndpoint = "{% url 'products:brands_by_category' %}"
      const initialCategory = "{{ category.slug|default_if_none:'' }}"
      const initialBrand = "{{ brand.slug|default_if_none:'' }}"

      const populateBrands = (categorySlug, selectedBrand) => {
        brandSelect.disabled = true
        brandSelect.innerHTML = '<option value="">All</option>'

        const url = categorySlug ? `${brandEndpoint}?category=${categorySlug}` : brandEndpoint
        fetch(url)
          .then((res) => res.json())
          .then((data) => {
            data.forEach((b) => {
              const opt = document.createElement('option')
              opt.value = b.slug
              opt.textContent = b.name
              if (selectedBrand && selectedBrand === b.slug) opt.selected = true
              brandSelect.appendChild(opt)
            })
          })
          .finally(() => {
            brandSelect.disabled = false
          })
      }

      dropdownHeader.addEventListener('click', () => {
        dropdownList.style.display = dropdownList.style.display === 'block' ? 'none' : 'block'
      })

      document.querySelectorAll('.dropdown-item').forEach((item) => {
        item.addEventListener('click', function (e) {
          e.stopPropagation()

          const nested = this.querySelector(':scope > .nested-list')
          if (nested) {
            nested.style.display = nested.style.display === 'none' ? 'block' : 'none'
          }

          document.querySelectorAll('.dropdown-item').forEach((b) =>
            b.classList.remove('selected', 'parent', 'child')
          )

          this.classList.add('selected')
          if (nested) this.classList.add('parent')
          else this.classList.add('child')

          populateBrands(this.dataset.slug, '')
        })
      })

      document.getElementById('apply-filter').addEventListener('click', () => {
        const selectedCategory = document.querySelector('.dropdown-item.selected')
        const brand = document.querySelector("select[name='brand']").value

        let url = "?"

        if (selectedCategory) {
          url += `category=${selectedCategory.dataset.slug}&`
        }
        if (brand) {
          url += `brand=${brand}`
        }

        window.location.href = url
      })

      // preload brand options based on current filters
      populateBrands(initialCategory, initialBrand)
    })
  </script>
{% endblock %}
